services:
  # ========================================
  # Next.js Application
  # ========================================
  hafalan-app:
    image: ghcr.io/${GITHUB_REPOSITORY:-muhrobby/hafalan}:${IMAGE_TAG:-latest}
    container_name: hafalan-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - DIRECT_URL=${DIRECT_URL:-${DATABASE_URL}}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://hafalan.yourdomain.com}
    networks:
      - traefik-network
      - internal
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.hafalan.rule=Host(`${DOMAIN:-hafalan.yourdomain.com}`)"
      - "traefik.http.routers.hafalan.entrypoints=websecure"
      - "traefik.http.routers.hafalan.tls=true"
      - "traefik.http.routers.hafalan.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.hafalan.loadbalancer.server.port=3000"

      # Middlewares
      - "traefik.http.routers.hafalan.middlewares=hafalan-headers,hafalan-compress"

      # Security Headers
      - "traefik.http.middlewares.hafalan-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.hafalan-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.hafalan-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.hafalan-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.hafalan-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.hafalan-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.hafalan-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.hafalan-headers.headers.frameDeny=true"

      # Compression
      - "traefik.http.middlewares.hafalan-compress.compress=true"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/auth/session",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ========================================
  # PostgreSQL Database (Optional - if not using external DB)
  # ========================================
  # hafalan-db:
  #   image: postgres:16-alpine
  #   container_name: hafalan-db
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-hafalan}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD}
  #     POSTGRES_DB: ${DB_NAME:-hafalan}
  #   volumes:
  #     - hafalan-db-data:/var/lib/postgresql/data
  #   networks:
  #     - internal
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-hafalan}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

networks:
  traefik-network:
    external: true
  internal:
    driver: bridge
# volumes:
#   hafalan-db-data:
